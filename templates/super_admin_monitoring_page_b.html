<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Form Review Delay Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet" />
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #f2f2f2;
        }
        .delayed {
            background-color: #ffcccc;
        }
    </style>
</head>
<body>

    <h2>Form Review Delay Tracker</h2>
  {% if forms_list %}
  {% for item in forms_list%}
    <h5
        class="text-primary d-flex justify-content-between align-items-center"
        role="button"
        data-bs-toggle="collapse"
        data-bs-target="#{{loop.index}}"
        aria-expanded="false"
        aria-controls="{{loop.index}}"
        style="cursor: pointer">
        {{item.applicant_name}}
        <i class="fas fa-chevron-down ms-2" id="idpIconCACEA711"></i>
    </h5>

    <div class="border rounded p-3 bg-white shadow-sm">
        <div class="collapse" id="{{loop.index}}">
            <table id="formsTable">
        <thead>
            <tr>
                <th>Applicant Name</th>
                <th>Risk Rating</th>
                <th>Submitted At</th>
                <th>Supervisor</th>
                <th>1st Reviewer</th>
                <th>2nd Reviewer</th>
                <th>Submitted to REC</th>
                <th>Certificate Issued Date</th>
                <th>Certificate Received</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>{{item.applicant_name}}</td>
                <td>{{item.risk_level}}</td>
                <td>{{item.submitted_at.strftime('%Y-%m-%d')}}
                    <br>
                    {% set days_delayed_ = (namespace(value=(current_time - item.submitted_at).days)) %}
                        {% if days_delayed_.value>0 %}
                        Delay: {{ days_delayed_.value }} Day(s) ago 
                    {% else %}
                    Submitted Today
                    {% endif %}
                </td>
                <td>{{item.supervisor}}</td>
                <td>
                    {{item.first_reviewer_name}}
                    <br>
                    Submitted at: {{item.review_signature_date.strftime('%Y-%m-%d')}}
                    <br>
                    {% set days_delayed = (namespace(value=(current_time - item.review_signature_date).days)) %}
                        {% if days_delayed.value>0 %}
                        Delay: {{ days_delayed.value }} Day(s) ago 
                    {% else %}
                    Submitted Today
                    {% endif %}
                </td>
                <td>
                   
                    {{item.second_reviewer_name}}
                    
                    <br>
                    Submitted at: {{item.review_signature_date1.strftime('%Y-%m-%d')}}
                    <br>
                    {% set days_delayed1 = (namespace(value=(current_time - item.review_signature_date1).days)) %}
                        {% if days_delayed1.value>0 %}
                        Delay: {{ days_delayed1.value }} Day(s) ago 
                    {% else %}
                    Submitted Today
                    {% endif %}
                </td>
                <td>{{item.submitted_to_rec}}</td>
                <td>{{item.certificate_issued}}</td>
                <td>{{item.certificate_received}}</td>
            </tr>
        </tbody>
    </table>
        </div>
    </div>
    {% endfor %}

    {% endif %}

    <!-- Bootstrap JS (needed for collapse to work) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const toggleHeaders = document.querySelectorAll('[data-bs-toggle="collapse"]');

            toggleHeaders.forEach(function (header) {
                const targetSelector = header.getAttribute("data-bs-target");
                const collapseEl = document.querySelector(targetSelector);
                const icon = header.querySelector("i");

                if (collapseEl && icon) {
                    collapseEl.addEventListener("show.bs.collapse", function () {
                        icon.classList.remove("fa-chevron-down");
                        icon.classList.add("fa-chevron-up");
                    });

                    collapseEl.addEventListener("hide.bs.collapse", function () {
                        icon.classList.remove("fa-chevron-up");
                        icon.classList.add("fa-chevron-down");
                    });
                }
            });
        });
    </script>
</body>
</html>
